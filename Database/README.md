# Database - How it works?

The database file defines how the API will act itself. It is based on a JSON structure with the next sections.

## Devices

In this section are all devices associated with the user, for example lights, thermostats, washers, fans, ...

Each devices must follow the JSON structure define by Google.

In 'database_example.json' there is only a light that shows like so:

```
{
  "deviceInfo" : {
    "hwVersion" : "2.1",
    "manufacturer" : "EnriqueGomez",
    "model" : "ACR",
    "swVersion" : "1.0"
  },
  "id" : "light",
  "name" : {
    "defaultNames" : [ "ACR 2.1" ],
    "name" : "ACR 2.1",
    "nicknames" : [ "Bulb"]
  },
  "traits" : [ "action.devices.traits.OnOff", "action.devices.traits.Brightness" ],
  "type" : "action.devices.types.LIGHT"
}
```
This JSON follows Google's rules: <a href="https://developers.google.com/actions/smarthome/guides/light">https://developers.google.com/actions/smarthome/guides/light</a>

You can see all devices available in Google's reference for Smart Home <a href="https://developers.google.com/actions/smarthome/guides/">https://developers.google.com/actions/smarthome/guides/</a>

You can create new devices writing them inside `"devices" : []` separated by commas.

###### Immportant

- id -> It is an unique id for each device. You can not have two bulbs with the same id.
- nicknames -> They are the names with you can use to call the device from the Google Assistant (Hi Google, Turn Bulb on).

## Status

Is the part in with we can find the status of the devices. This section is autogenerated when you change the device's value for first time from Google Assistant or from Google Home App.

For example, a light could have three different states:

- brightness -> The brightness value.
- on -> On or Off status.
- online -> If the device is reading its values from the database or not, maybe the device has reset it self or it has lost his connection.

```
"light" : {
  "brightness" : 100,
  "on" : true,
  "online" : true
}
```

##### Immportant

In this case `light` is the device id

## Alive

This is used by the API in order to know when was the last time that a device communicate with the API. If the time past is larger than 20 seconds the API considers that the device is offline and change its *online* value in the status section.

This section is autogenerated when the device communicate with the API for first time.

```
"light" : {
  "timestamp" : 1558948640991
}
```

## Token

In this section the API stores all tokens requested by externals APIs or by the devices.

```
"google" : {
  "access_token" : {
    "timestamp" : 1559911840449,
    "value" : "token"
  },
  "authorization_code" : {
    "timestamp" : 1559488874863,
    "value" : "code"
  },
  "client_id" : "1234",
  "client_secret" : "456",
  "refresh_token" : {
    "timestamp" : 1559488875703,
    "value" : "token"
  }
},
"light" : {
  "access_token" : {
    "timestamp" : 1559847064459,
    "value" : "token"
  },
  "authorization_code" : {
    "timestamp" : "patata",
    "value" : "llight-code"
  },
  "refresh_token" : {
    "timestamp" : 1559847064459,
    "value" : "token"
  }
}
```

The only thing that you need to change here are the `client_id` and `client_secret` for Google if needed.

##### Immportant

When you create a new device in the *devices* section you **MUST** create its token's JSON and assigne it a *authorization_code*. This authorization_code must be used in the Arduino code.

In *light* case the *authorization_code* is `light-code`.

In order to create a device's JSON use the next JSON **changing the device id and authorization_code**.

```
"Put device's id here" : {
  "access_token" : {
    "timestamp" : 0,
    "value" : "token"
  },
  "authorization_code" : {
    "timestamp" : "patata",
    "value" : "Put the device's authorization_code here"
  },
  "refresh_token" : {
    "timestamp" : 0,
    "value" : "token"
  }
}
```
